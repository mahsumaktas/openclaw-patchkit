import fs from "node:fs";
import { homedir } from "node:os";
import { join } from "node:path";

export type MemoryState = "active" | "fading" | "dormant" | "superseded";

export type MemoryConfig = {
  embedding: {
    provider: "openai";
    model?: string;
    apiKey: string;
  };
  dbPath?: string;
  autoCapture?: boolean;
  autoRecall?: boolean;
  captureMaxChars?: number;
  // PR A: Activation scoring weights
  similarityWeight?: number;   // default 0.50
  activationWeight?: number;   // default 0.35
  importanceWeight?: number;   // default 0.15
  // PR A: Confidence gating
  confidenceThreshold?: number; // default 0.35
  // PR B: Semantic dedup
  deduplicationThreshold?: number; // default 0.85
  // PR C: Memory decay
  decayEnabled?: boolean;       // default true
  fadingThreshold?: number;     // default 0.3
  dormantThreshold?: number;    // default 0.1
  decayOnStartup?: boolean;     // default true
  // v3: Enforced RAG
  enforcedRag?: boolean;              // default true (replaces autoRecall)
  ragThreshold?: number;              // default 0.75
  ragTopK?: number;                   // default 3
  // v3: Capture pipeline
  captureMode?: "heuristic" | "hybrid";  // default "hybrid"
  captureHeuristicThreshold?: number;    // default 0.2
  captureLlmThreshold?: number;          // default 0.5
  captureLlmModel?: string;              // default "gpt-4o-mini"
  // v3.2: Mood detection
  moodDetection?: boolean;               // default true
  // v4: Self-pruning
  pruneEnabled?: boolean;                // default true
  pruneMaxAgeDays?: number;              // default 30
};

export const MEMORY_CATEGORIES = ["preference", "fact", "decision", "entity", "correction", "other"] as const;
export type MemoryCategory = (typeof MEMORY_CATEGORIES)[number];

const DEFAULT_MODEL = "text-embedding-3-small";
export const DEFAULT_CAPTURE_MAX_CHARS = 500;
const LEGACY_STATE_DIRS: string[] = [];

function resolveDefaultDbPath(): string {
  const home = homedir();
  const preferred = join(home, ".openclaw", "memory", "lancedb");
  try {
    if (fs.existsSync(preferred)) {
      return preferred;
    }
  } catch {
    // best-effort
  }

  for (const legacy of LEGACY_STATE_DIRS) {
    const candidate = join(home, legacy, "memory", "lancedb");
    try {
      if (fs.existsSync(candidate)) {
        return candidate;
      }
    } catch {
      // best-effort
    }
  }

  return preferred;
}

const DEFAULT_DB_PATH = resolveDefaultDbPath();

const EMBEDDING_DIMENSIONS: Record<string, number> = {
  "text-embedding-3-small": 1536,
  "text-embedding-3-large": 3072,
};

function assertAllowedKeys(value: Record<string, unknown>, allowed: string[], label: string) {
  const unknown = Object.keys(value).filter((key) => !allowed.includes(key));
  if (unknown.length === 0) {
    return;
  }
  throw new Error(`${label} has unknown keys: ${unknown.join(", ")}`);
}

export function vectorDimsForModel(model: string): number {
  const dims = EMBEDDING_DIMENSIONS[model];
  if (!dims) {
    throw new Error(`Unsupported embedding model: ${model}`);
  }
  return dims;
}

function resolveEnvVars(value: string): string {
  return value.replace(/\$\{([^}]+)\}/g, (_, envVar) => {
    const envValue = process.env[envVar];
    if (!envValue) {
      throw new Error(`Environment variable ${envVar} is not set`);
    }
    return envValue;
  });
}

function resolveEmbeddingModel(embedding: Record<string, unknown>): string {
  const model = typeof embedding.model === "string" ? embedding.model : DEFAULT_MODEL;
  vectorDimsForModel(model);
  return model;
}

export const memoryConfigSchema = {
  parse(value: unknown): MemoryConfig {
    if (!value || typeof value !== "object" || Array.isArray(value)) {
      throw new Error("memory config required");
    }
    const cfg = value as Record<string, unknown>;
    assertAllowedKeys(
      cfg,
      [
        "embedding", "dbPath", "autoCapture", "autoRecall", "captureMaxChars",
        "similarityWeight", "activationWeight", "importanceWeight",
        "confidenceThreshold", "deduplicationThreshold",
        "decayEnabled", "fadingThreshold", "dormantThreshold", "decayOnStartup",
        "enforcedRag", "ragThreshold", "ragTopK",
        "captureMode", "captureHeuristicThreshold", "captureLlmThreshold", "captureLlmModel",
        "moodDetection",
        "pruneEnabled", "pruneMaxAgeDays",
      ],
      "memory config",
    );

    const embedding = cfg.embedding as Record<string, unknown> | undefined;
    if (!embedding || typeof embedding.apiKey !== "string") {
      throw new Error("embedding.apiKey is required");
    }
    assertAllowedKeys(embedding, ["apiKey", "model"], "embedding config");

    const model = resolveEmbeddingModel(embedding);

    const captureMaxChars =
      typeof cfg.captureMaxChars === "number" ? Math.floor(cfg.captureMaxChars) : undefined;
    if (
      typeof captureMaxChars === "number" &&
      (captureMaxChars < 100 || captureMaxChars > 10_000)
    ) {
      throw new Error("captureMaxChars must be between 100 and 10000");
    }

    return {
      embedding: {
        provider: "openai",
        model,
        apiKey: resolveEnvVars(embedding.apiKey),
      },
      dbPath: typeof cfg.dbPath === "string" ? cfg.dbPath : DEFAULT_DB_PATH,
      autoCapture: cfg.autoCapture === true,
      autoRecall: cfg.autoRecall !== false,
      captureMaxChars: captureMaxChars ?? DEFAULT_CAPTURE_MAX_CHARS,
      // Activation scoring weights (must sum to 1.0)
      similarityWeight: typeof cfg.similarityWeight === "number" ? cfg.similarityWeight : 0.5,
      activationWeight: typeof cfg.activationWeight === "number" ? cfg.activationWeight : 0.35,
      importanceWeight: typeof cfg.importanceWeight === "number" ? cfg.importanceWeight : 0.15,
      // Confidence gating
      confidenceThreshold: typeof cfg.confidenceThreshold === "number" ? cfg.confidenceThreshold : 0.35,
      // Semantic dedup
      deduplicationThreshold: typeof cfg.deduplicationThreshold === "number" ? cfg.deduplicationThreshold : 0.85,
      // Memory decay
      decayEnabled: cfg.decayEnabled !== false,
      fadingThreshold: typeof cfg.fadingThreshold === "number" ? cfg.fadingThreshold : 0.3,
      dormantThreshold: typeof cfg.dormantThreshold === "number" ? cfg.dormantThreshold : 0.1,
      decayOnStartup: cfg.decayOnStartup !== false,
      // v3: Enforced RAG
      enforcedRag: cfg.enforcedRag !== false,
      ragThreshold: typeof cfg.ragThreshold === "number" ? cfg.ragThreshold : 0.75,
      ragTopK: typeof cfg.ragTopK === "number" ? Math.floor(cfg.ragTopK) : 3,
      // v3: Capture pipeline
      captureMode: cfg.captureMode === "heuristic" ? "heuristic" : "hybrid",
      captureHeuristicThreshold: typeof cfg.captureHeuristicThreshold === "number" ? cfg.captureHeuristicThreshold : 0.2,
      captureLlmThreshold: typeof cfg.captureLlmThreshold === "number" ? cfg.captureLlmThreshold : 0.5,
      captureLlmModel: typeof cfg.captureLlmModel === "string" ? cfg.captureLlmModel : "gpt-4o-mini",
      // v3.2: Mood detection
      moodDetection: cfg.moodDetection !== false,
      // v4: Self-pruning
      pruneEnabled: cfg.pruneEnabled !== false,
      pruneMaxAgeDays: typeof cfg.pruneMaxAgeDays === "number" ? Math.floor(cfg.pruneMaxAgeDays) : 30,
    };
  },
  uiHints: {
    "embedding.apiKey": {
      label: "OpenAI API Key",
      sensitive: true,
      placeholder: "sk-proj-...",
      help: "API key for OpenAI embeddings (or use ${OPENAI_API_KEY})",
    },
    "embedding.model": {
      label: "Embedding Model",
      placeholder: DEFAULT_MODEL,
      help: "OpenAI embedding model to use",
    },
    dbPath: {
      label: "Database Path",
      placeholder: "~/.openclaw/memory/lancedb",
      advanced: true,
    },
    autoCapture: {
      label: "Auto-Capture",
      help: "Automatically capture important information from conversations",
    },
    autoRecall: {
      label: "Auto-Recall",
      help: "Automatically inject relevant memories into context",
    },
    captureMaxChars: {
      label: "Capture Max Chars",
      help: "Maximum message length eligible for auto-capture",
      advanced: true,
      placeholder: String(DEFAULT_CAPTURE_MAX_CHARS),
    },
  },
};
